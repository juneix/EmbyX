<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#000000">
    
    <link rel="manifest" href="manifest.json">
    
    <link rel="icon" type="image/png" href="icon.png">
    <link rel="apple-touch-icon" href="icon.png">

    <title>EmbyX</title>
    <script src="https://cdn.tailwindcss.com" data-cfasync="false"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script data-cfasync="false">
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#fe2c55', // æŠ–éŸ³çº¢
                        secondary: '#25f4ee', // æŠ–éŸ³è“
                        dark: '#161823',
                        light: '#f8f9fa'
                    },
                    fontFamily: {
                        sans: ['PingFang SC', 'Helvetica Neue', 'Arial', 'sans-serif']
                    }
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            /* è§†é¢‘å…¨å±æ ·å¼ - ä¿®å¤ï¼šç§»é™¤ hiddenï¼Œç¡®ä¿ display æ­£å¸¸ï¼Œä¿®æ­£ z-index */
            .video-fullscreen {
                @apply w-full h-full object-cover absolute inset-0 z-10;
            }
            
            /* æ»‘åŠ¨å®¹å™¨ */
            /* ä¼˜åŒ– 2: h-screen æ”¹ä¸º h-[100dvh] é€‚é…ç§»åŠ¨ç«¯åŠ¨æ€é«˜åº¦ */
            .slide-container {
                @apply relative w-screen h-[100dvh] overflow-hidden bg-black;
            }
            
            /* å•ä¸ªè§†é¢‘å¡ç‰‡ */
            .slide-item {
                @apply absolute top-0 left-0 w-full h-full transition-transform duration-300 ease-out z-10;
            }
            
            /* æ’­æ”¾/æš‚åœæŒ‰é’®åŠ¨ç”» - ä¿®å¤ï¼šæé«˜ z-index ç¡®ä¿åœ¨è§†é¢‘ä¹‹ä¸Š */
            .play-pause-btn {
                @apply absolute top-1/2 left-1/2 w-16 h-16 rounded-full flex items-center justify-center z-20 opacity-0 pointer-events-none transition-all duration-200 ease-out bg-black/30;
                transform: translate(-50%, -50%) scale(1.5);
            }
            .play-pause-btn.paused {
                @apply opacity-100;
                transform: translate(-50%, -50%) scale(1.5);
            }
            .play-pause-btn i {
                @apply text-2xl text-white;
            }

            /* æ¸…å±æ¨¡å¼é€»è¾‘ */
            .interface-hidden .bottom-info,
            .interface-hidden .bottom-nav {
                @apply opacity-0 pointer-events-none transition-opacity duration-300;
            }
            /* éšè—å³ä¾§æ é™¤æ¸…å±æŒ‰é’®å¤–çš„å…ƒç´  */
            .interface-hidden .right-toolbar > div:not(.clear-screen-wrapper) {
                @apply opacity-0 pointer-events-none;
            }
            
            /* â€œæˆ‘çš„â€é¡µé¢å±‚çº§è¿‡æ¸¡ */
            .profile-layer {
                @apply fixed top-0 left-0 w-full h-full bg-[#161823] z-[60] translate-y-full transition-transform duration-300 ease-in-out overflow-y-auto pb-[env(safe-area-inset-bottom)];
            }
            .profile-layer.active {
                @apply translate-y-0;
            }

            /* è¿›åº¦æ¡ */
            .progress-line {
                @apply h-full bg-white transition-[width] duration-100 ease-linear;
            }
        }
    </style>
</head>
<body class="bg-black text-white overflow-hidden font-sans select-none overscroll-none">
    <div id="app" class="slide-container">
        
        <div id="videoContainer" class="relative w-full h-full">
            </div>

        <div id="clickToPlayOverlay" class="absolute inset-0 z-50 flex items-center justify-center bg-black/40 cursor-pointer">
            <div class="text-center">
                <div class="w-20 h-20 bg-black/50 rounded-full flex items-center justify-center animate-pulse mx-auto">
                    <i class="fa fa-play text-white text-3xl ml-1"></i>
                </div>
                <p class="text-white text-lg mt-4 font-medium">ç‚¹å‡»å¼€å§‹æ’­æ”¾</p>
            </div>
        </div>

        <div class="right-toolbar absolute right-4 bottom-32 flex flex-col items-center space-y-6 z-30 transition-opacity duration-300">
            <div class="flex flex-col items-center cursor-pointer active:scale-90 transition-transform" id="favoriteBtn">
                <div class="w-12 h-12 flex items-center justify-center">
                    <i class="fa fa-heart text-white text-4xl drop-shadow-md"></i>
                </div>
                <span class="text-xs mt-1 font-medium drop-shadow">æ”¶è—</span>
            </div>

            <div class="flex flex-col items-center clear-screen-wrapper cursor-pointer active:scale-90 transition-transform transition-opacity duration-300" id="clearScreenBtn">
                <div class="w-12 h-12 flex items-center justify-center">
                    <i class="fa fa-eye-slash text-white text-4xl drop-shadow-md"></i>
                </div>
                <span class="text-xs mt-1 font-medium drop-shadow">æ¸…å±</span>
            </div>

            <div class="flex flex-col items-center cursor-pointer active:scale-90 transition-transform" id="fullscreenBtn">
                <div class="w-12 h-12 flex items-center justify-center">
                    <i class="fa fa-expand text-white text-4xl drop-shadow-md"></i>
                </div>
                <span class="text-xs mt-1 font-medium drop-shadow">å…¨å±</span>
            </div>

            <div class="flex flex-col items-center cursor-pointer active:scale-90 transition-transform" id="muteBtn">
                <div class="w-12 h-12 flex items-center justify-center">
                    <i class="fa fa-volume-up text-white text-4xl drop-shadow-md"></i>
                </div>
                <span class="text-xs mt-1 font-medium drop-shadow">é™éŸ³</span>
            </div>
        </div>

        <div class="bottom-info absolute bottom-16 left-4 right-4 z-20 transition-opacity duration-300 pointer-events-none">
            <div class="mb-3 pointer-events-auto">
                <h3 id="videoTitle" class="text-white text-lg font-medium mb-1 drop-shadow-md truncate">æ­£åœ¨åˆå§‹åŒ–...</h3>
                <p id="videoDescription" class="text-gray-200 text-sm line-clamp-2 drop-shadow-md opacity-90">è¯·ç‚¹å‡»å³ä¸‹è§’â€œæˆ‘çš„â€è¿›è¡ŒæœåŠ¡å™¨é…ç½®</p>
            </div>

            <div class="relative h-1 bg-white/30 cursor-pointer pointer-events-auto mb-1" id="progressBarContainer">
                <div id="progressLine" class="progress-line w-0"></div>
            </div>
            
            <div class="flex justify-between text-xs text-gray-300 drop-shadow">
                <span id="currentTime">00:00</span>
                <span id="totalTime">00:00</span>
            </div>
        </div>

        <div class="bottom-nav absolute bottom-0 left-0 right-0 bg-black/50 backdrop-blur-sm z-30 transition-opacity duration-300 pb-[env(safe-area-inset-bottom)]">
            <div class="flex justify-around items-center h-16">
                <div id="playModeBtn" class="flex flex-col items-center justify-center w-1/4 text-primary cursor-pointer">
                    <i class="fa fa-repeat text-lg"></i>
                    <span class="text-xs mt-1">é¡ºåºæ’­æ”¾</span>
                </div>
                <div id="libraryBtn" class="flex flex-col items-center justify-center w-1/4 text-gray-400 cursor-pointer">
                    <i class="fa fa-film text-lg"></i>
                    <span class="text-xs mt-1">åª’ä½“åº“</span>
                </div>
                <div id="favoritesBtn" class="flex flex-col items-center justify-center w-1/4 text-gray-400 cursor-pointer">
                    <i class="fa fa-heart text-lg"></i>
                    <span class="text-xs mt-1">å·²æ”¶è—</span>
                </div>
                <div id="myBtn" class="flex flex-col items-center justify-center w-1/4 text-gray-400 cursor-pointer">
                    <i class="fa fa-user text-lg"></i>
                    <span class="text-xs mt-1">æˆ‘çš„</span>
                </div>
            </div>
        </div>

        <div id="profilePage" class="profile-layer text-white">
            <div class="flex items-center h-14 px-4 border-b border-gray-800 bg-dark sticky top-0 z-10">
                <button id="closeProfileBtn" class="w-10 h-10 flex items-center justify-center -ml-2 active:text-gray-300">
                    <i class="fa fa-chevron-down text-gray-400"></i>
                </button>
                <span class="font-bold text-lg ml-2">ä¸ªäººä¸­å¿ƒ</span>
            </div>

            <div class="p-4">
                <div class="mb-6">
                    <h2 class="text-primary font-bold text-sm mb-4 flex items-center">
                        <i class="fa fa-server mr-2"></i>æœåŠ¡å™¨é…ç½®
                    </h2>
                    <div class="space-y-4 bg-gray-800/40 p-4 rounded-lg border border-gray-700/50">
                        <div>
                            <label class="text-gray-400 text-xs block mb-1.5">æœåŠ¡å™¨åœ°å€</label>
                            <input type="text" id="configServer" placeholder="ä¾‹å¦‚ http://10.1.1.3:8096" 
                                class="w-full bg-gray-900 text-white text-sm rounded px-3 py-2.5 outline-none border border-gray-700 focus:border-primary transition-colors">
                        </div>
                        <div>
                            <label class="text-gray-400 text-xs block mb-1.5">API å¯†é’¥</label>
                            <input type="text" id="configKey" placeholder="æ§åˆ¶å°-é«˜çº§-æ–°å»º API å¯†é’¥" 
                                class="w-full bg-gray-900 text-white text-sm rounded px-3 py-2.5 outline-none border border-gray-700 focus:border-primary transition-colors">
                        </div>
                        <div class="flex items-center space-x-2 py-1">
                            <input type="checkbox" id="configStatic" class="rounded text-primary focus:ring-0 bg-gray-700 border-none" checked>
                            <label for="configStatic" class="text-gray-400 text-xs">ä½¿ç”¨ Static æ¨¡å¼ (æé«˜å…¼å®¹æ€§)</label>
                        </div>
                        <div class="flex space-x-3 pt-2">
                            <button id="resetConfigBtn" class="flex-1 bg-gray-700 hover:bg-gray-600 text-white text-sm py-3 rounded-lg active:scale-95 transition-transform">é‡ç½®</button>
                            <button id="saveConfigBtn" class="flex-1 bg-primary hover:bg-primary/90 text-white text-sm py-3 rounded-lg font-bold active:opacity-80 shadow-lg shadow-primary/20">ä¿å­˜å¹¶è¿æ¥</button>
                        </div>
                    </div>
                </div>

                <div class="h-px bg-gray-800 w-full my-6"></div>

                <div>
                    <h2 class="text-primary font-bold text-sm mb-4 flex items-center">
                        <i class="fa fa-info-circle mr-2"></i>å…³äºé¡¹ç›®
                    </h2>
                    <div class="bg-gray-800/40 p-5 rounded-xl border border-gray-700/50 space-y-5 text-sm text-gray-300 leading-relaxed">
                        <div class="flex items-center">
                            <h3 class="text-white font-bold text-2xl tracking-tight">ğŸ“± EmbyX</h3>
                            <span class="ml-2 px-2 py-0.5 bg-primary/20 text-primary text-xs font-bold rounded-full border border-primary/30">v1.0</span>
                        </div>
                        
                        <div>
                            <p class="text-gray-300">ğŸ’¡ ç®€ä»‹ï¼šè¿™æ˜¯ä¸€ä¸ªæŠ€æœ¯å°ç™½å€ŸåŠ© AI ä»£ç å·¥å…·å’Œ Emby å®˜æ–¹ API åˆ¶ä½œçš„ Web åº”ç”¨ï¼Œä»¿æŠ–éŸ³é£æ ¼æµè§ˆä¸‹è½½çš„çŸ­è§†é¢‘ã€‚ç›®å‰åŠŸèƒ½è¿˜å¾ˆç®€é™‹ï¼Œå°±å½“æŠ›ç –å¼•ç‰äº†ï¼Œæ¬¢è¿æŠ€æœ¯å¤§ä½¬æŒ‡ç‚¹æˆ–ç›´æ¥äºŒæ”¹ã€‚</p>
                        </div>
                        
                        <div class="text-yellow-500/90 text-xs bg-yellow-500/10 p-3 rounded-lg border border-yellow-500/20">
                            <i class="fa fa-exclamation-triangle mr-1"></i> æé†’ï¼šæœ¬æ¼”ç¤ºç«™ç‚¹çš„æ•°æ®ä»…æœ¬åœ°ä¿å­˜ï¼Œä¸ºä¿éšœç¨³å®šå’Œéšç§ï¼Œå»ºè®®ç§æœ‰åŒ–éƒ¨ç½²ã€‚ 
                        </div>

                        <div>
                            <h4 class="text-gray-300">ğŸ§© ç”¨æ³•</h4>
                            <ul class="list-disc list-inside space-y-1 text-gray-400 text-xs">
                                <li>è‹¹æœ Safari æµè§ˆå™¨ã€åˆ†äº«-æ·»åŠ åˆ°ä¸»å±å¹•ã€‘ï¼Œå³å¯å®ç° PWA å…¨å±åº”ç”¨ã€‚</li>
                                <li>å®‰å“ Chrome/Edge æµè§ˆå™¨ï¼Œè¯·ç›´æ¥ä½¿ç”¨å…¨å±æŒ‰é’®ã€‚</li>
                                <li>å¦‚éœ€è‡ªåŠ¨åŒ–ã€æ‰¹é‡ä¸‹è½½è§†é¢‘ï¼Œæ¨èæ­é… <code class="bg-gray-700 px-1 rounded text-xs text-gray-200">yt-dlp</code>ã€<code class="bg-gray-700 px-1 rounded text-xs text-gray-200">gallery-dl</code>ã€<code class="bg-gray-700 px-1 rounded text-xs text-gray-200">Douyin_TikTok_Download_API</code> ç­‰å¼€æºé¡¹ç›®ã€‚</li>
                                <li>æœ¬äººå¦æœ‰ç‹¬å®¶é€‚é…çš„è‹¹æœã€å®‰å“å¿«æ·æŒ‡ä»¤ï¼Œå¯ä¸€é”®ä¸‹è½½è§†é¢‘åˆ° NASï¼Œç„¶åå®ç° Emby è‡ªåŠ¨å…¥åº“ã€‚</li>
                            </ul>
                        </div>

                        <div class="pt-4 border-t border-gray-700/50 text-xs text-gray-500 flex flex-col space-y-1">
                            <p>ğŸ‘¨ğŸ»â€ğŸ’» æ•°å­—åç‰‡ï¼š<a href="https://juneix.github.io" target="_blank" class="text-primary hover:underline">@è°¢é€±äº”</a></p>
                            <p>ğŸ  æ›´å¤šå†…å®¹ï¼š<a href="https://5nav.eu.org" target="_blank" class="text-primary hover:underline">è°¢é€±äº”ã®è—ç»é˜</a></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="libraryModal" class="fixed inset-0 bg-black/80 z-50 flex items-center justify-center hidden">
            <div class="bg-gray-900 rounded-xl p-5 w-72 max-h-[70vh] overflow-y-auto border border-gray-800 shadow-2xl">
                <h3 class="text-white text-lg font-bold mb-4 text-center">é€‰æ‹©åª’ä½“åº“</h3>
                <div id="librariesList" class="space-y-2"></div>
                <button id="closeLibraryBtn" class="w-full mt-4 bg-gray-800 text-gray-300 py-2 rounded text-sm hover:bg-gray-700">å…³é—­</button>
            </div>
        </div>

        <div id="toast" class="fixed top-16 left-1/2 -translate-x-1/2 bg-black/80 px-4 py-2 rounded-full text-white text-sm pointer-events-none transition-opacity duration-300 opacity-0 z-[100] whitespace-nowrap border border-white/10 backdrop-blur-sm">
            æç¤ºä¿¡æ¯
        </div>
        <div id="loading" class="fixed inset-0 z-40 flex items-center justify-center bg-transparent pointer-events-none hidden">
            <div class="w-10 h-10 border-4 border-gray-600 border-t-primary rounded-full animate-spin"></div>
        </div>
    </div>

    <script>
        /**
         * EmbyX Core Logic
         * åŒ…å«é…ç½®ç®¡ç†ã€æ’­æ”¾å™¨æ ¸å¿ƒã€UI äº¤äº’ã€æ‰‹åŠ¿æ§åˆ¶
         */
        class EmbyApp {
            constructor() {
                // åº”ç”¨çŠ¶æ€
                this.state = {
                    videos: [],
                    currentIndex: 0,
                    isPlaying: false,
                    favorites: new Set(),
                    playMode: 'sequence', // sequence | random
                    isClearScreen: false,
                    currentTab: 'home', // home | favorites | my
                    currentLibraryId: null
                };

                // é…ç½®ä¿¡æ¯
                this.config = { server: '', apiKey: '', useStatic: true };

                // è§¦æ‘¸çŠ¶æ€ç¼“å­˜
                this.touch = { startY: 0, startTime: 0 };

                // è®¡æ—¶å™¨å¼•ç”¨
                this.csTimer = null;

                this.dom = {}; // DOM å…ƒç´ ç¼“å­˜
                this.init();
            }

            // --- åˆå§‹åŒ– ---
            init() {
                this.cacheDOM();
                this.loadConfig();
                this.loadFavorites();
                this.bindEvents();

                // æ£€æŸ¥é…ç½®å¹¶å¯åŠ¨
                if (this.config.server && this.config.apiKey) {
                    this.fetchVideos();
                } else {
                    setTimeout(() => this.toggleModal('profilePage', true), 500);
                }
            }

            cacheDOM() {
                const ids = [
                    'videoContainer', 'clickToPlayOverlay', 'loading', 'toast',
                    'videoTitle', 'videoDescription', 'progressLine', 'currentTime', 'totalTime',
                    'playModeBtn', 'libraryBtn', 'favoritesBtn', 'myBtn',
                    'favoriteBtn', 'clearScreenBtn', 'fullscreenBtn', 'muteBtn',
                    'configServer', 'configKey', 'configStatic'
                ];
                ids.forEach(id => this.dom[id] = document.getElementById(id));
            }

            // --- é…ç½®ä¸æ•°æ®ç®¡ç† ---
            loadConfig() {
                this.config.server = localStorage.getItem('emby_server') || '';
                this.config.apiKey = localStorage.getItem('emby_key') || '';
                this.config.useStatic = localStorage.getItem('emby_static') !== 'false';

                // å¡«å…… UI
                this.dom.configServer.value = this.config.server;
                this.dom.configKey.value = this.config.apiKey;
                this.dom.configStatic.checked = this.config.useStatic;
            }

            saveConfig() {
                const server = this.dom.configServer.value.trim();
                const key = this.dom.configKey.value.trim();
                const isStatic = this.dom.configStatic.checked;

                if (!server || !key) return this.showToast('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯');

                localStorage.setItem('emby_server', server);
                localStorage.setItem('emby_key', key);
                localStorage.setItem('emby_static', isStatic);

                this.config = { server, apiKey: key, useStatic: isStatic };
                this.showToast('é…ç½®å·²ä¿å­˜');
                this.toggleModal('profilePage', false);
                this.fetchVideos(); // é‡æ–°åŠ è½½
            }

            resetConfig() {
                if (confirm('ç¡®å®šè¦é‡ç½®æ‰€æœ‰é…ç½®å—ï¼Ÿ')) {
                    localStorage.clear();
                    location.reload();
                }
            }

            loadFavorites() {
                const saved = localStorage.getItem('emby_favorites');
                if (saved) this.state.favorites = new Set(JSON.parse(saved));
            }

            // --- æ ¸å¿ƒæ’­æ”¾é€»è¾‘ ---
            
            /**
             * è·å–è§†é¢‘åˆ—è¡¨
             * @param {string} parentId - åª’ä½“åº“ ID (å¯é€‰)
             * @param {string} ids - æŒ‡å®šè§†é¢‘ ID åˆ—è¡¨ (ç”¨äºæ”¶è—å¤¹æ¨¡å¼)
             */
            async fetchVideos(parentId = null, ids = null) {
                this.toggleLoading(true);
                try {
                    const { server, apiKey } = this.config;
                    let url = `${server}/emby/Items?api_key=${apiKey}&Recursive=true&IncludeItemTypes=Video&Limit=100&Fields=Overview,Path,RunTimeTicks`;

                    if (ids) {
                        url += `&Ids=${ids}`;
                    } else {
                        url += `&SortBy=DateCreated&SortOrder=Descending`;
                        if (parentId) url += `&ParentId=${parentId}`;
                    }

                    const res = await fetch(url);
                    const data = await res.json();

                    if (data && data.Items && data.Items.length > 0) {
                        this.state.videos = data.Items;
                        this.state.currentIndex = 0;
                        this.renderSlides();
                        this.loadVideo(0);
                    } else {
                        this.showToast('æ²¡æœ‰æ‰¾åˆ°è§†é¢‘');
                        this.dom.videoContainer.innerHTML = '';
                    }
                } catch (e) {
                    console.error(e);
                    this.showToast('æ— æ³•è¿æ¥æœåŠ¡å™¨');
                } finally {
                    this.toggleLoading(false);
                }
            }

            /**
             * æ¸²æŸ“è§†é¢‘å¡ç‰‡ç»“æ„ (DOM)
             */
            renderSlides() {
                this.dom.videoContainer.innerHTML = '';
                this.state.videos.forEach((video, index) => {
                    const el = document.createElement('div');
                    el.className = 'slide-item';
                    el.id = `slide-${index}`;
                    // åˆå§‹ä½ç½®ï¼šç¬¬ä¸€ä¸ªåœ¨è§†é‡å†…ï¼Œå…¶ä»–åœ¨ä¸‹æ–¹
                    el.style.transform = index === 0 ? 'translateY(0)' : 'translateY(100%)';

                    const posterSrc = this.getImageSrc(video.Id);
                    
                    // ä¿®å¤ï¼šåœ¨æ¨¡æ¿ä¸­æ˜¾å¼æ·»åŠ  hidden ç±»ï¼Œä¸ JS çš„ remove('hidden') é…åˆ
                    el.innerHTML = `
                        <div class="w-full h-full relative bg-black">
                            <div class="absolute inset-0 bg-cover bg-center opacity-60" style="background-image: url('${posterSrc}')"></div>
                            <video id="video-${index}" class="video-fullscreen hidden" playsinline webkit-playsinline loop></video>
                            <div id="playBtn-${index}" class="play-pause-btn">
                                <i class="fa fa-play"></i>
                            </div>
                        </div>
                    `;
                    this.dom.videoContainer.appendChild(el);
                });
                this.updateUI();
            }

            /**
             * åŠ è½½å¹¶å‡†å¤‡æ’­æ”¾æŒ‡å®šç´¢å¼•çš„è§†é¢‘
             */
            loadVideo(index) {
                // 1. æ¸…ç†æ—§è§†é¢‘ (æš‚åœå¹¶éšè—)
                this.state.videos.forEach((_, i) => {
                    if (i !== index) {
                        const v = document.getElementById(`video-${i}`);
                        if (v) {
                            v.pause();
                            v.classList.add('hidden');
                            v.src = ''; 
                            // ä¼˜åŒ– 4: å¼ºåˆ¶æ¸…ç†èµ„æº
                            v.removeAttribute('src');
                            v.load();
                        }
                    }
                });

                // 2. åŠ è½½æ–°è§†é¢‘
                const item = this.state.videos[index];
                if (!item) return;

                const videoEl = document.getElementById(`video-${index}`);
                videoEl.src = this.getVideoSrc(item.Id);
                
                // æ˜¾å¼ç§»é™¤ hidden ç±»ï¼Œä½¿ display: none å¤±æ•ˆ
                videoEl.classList.remove('hidden');

                // 3. ç»‘å®šæ—¶é—´æ›´æ–°äº‹ä»¶ (è¿›åº¦æ¡)
                videoEl.ontimeupdate = () => {
                    if (videoEl.duration) {
                        const pct = (videoEl.currentTime / videoEl.duration) * 100;
                        this.dom.progressLine.style.width = `${pct}%`;
                        this.dom.currentTime.textContent = this.formatTime(videoEl.currentTime);
                        this.dom.totalTime.textContent = this.formatTime(videoEl.duration);
                    }
                };

                this.updateUI();
            }

            playVideo(index) {
                const v = document.getElementById(`video-${index}`);
                const btn = document.getElementById(`playBtn-${index}`);
                if (v) {
                    v.play().then(() => {
                        this.state.isPlaying = true;
                        btn.classList.remove('paused');
                    }).catch(() => {
                        this.state.isPlaying = false;
                        btn.classList.add('paused');
                    });
                }
            }

            togglePlay() {
                const idx = this.state.currentIndex;
                const v = document.getElementById(`video-${idx}`);
                const btn = document.getElementById(`playBtn-${idx}`);
                if (!v) return;

                if (v.paused) {
                    v.play();
                    this.state.isPlaying = true;
                    btn.classList.remove('paused');
                } else {
                    v.pause();
                    this.state.isPlaying = false;
                    btn.classList.add('paused');
                }
            }

            // --- å¯¼èˆªä¸æ‰‹åŠ¿ ---
            
            nextVideo() {
                let nextIndex;
                if (this.state.playMode === 'random') {
                    nextIndex = Math.floor(Math.random() * this.state.videos.length);
                } else {
                    nextIndex = this.state.currentIndex + 1;
                }

                if (nextIndex >= this.state.videos.length) {
                    this.showToast('å·²ç»æ˜¯æœ€åä¸€ä¸ªè§†é¢‘äº†');
                    this.resetSlidePosition();
                    return;
                }
                this.switchSlide(nextIndex, 'up');
            }

            prevVideo() {
                if (this.state.currentIndex === 0) {
                    this.resetSlidePosition();
                    return;
                }
                this.switchSlide(this.state.currentIndex - 1, 'down');
            }

            switchSlide(newIndex, direction) {
                const currentEl = document.getElementById(`slide-${this.state.currentIndex}`);
                const nextEl = document.getElementById(`slide-${newIndex}`);

                // ç®€å•çš„ä¸Šä¸‹åˆ‡æ¢åŠ¨ç”»
                if (direction === 'up') {
                    currentEl.style.transform = 'translateY(-100%)';
                    nextEl.style.transform = 'translateY(0)';
                } else {
                    currentEl.style.transform = 'translateY(100%)';
                    nextEl.style.transform = 'translateY(0)';
                }

                this.state.currentIndex = newIndex;
                this.loadVideo(newIndex);
                this.playVideo(newIndex);
            }

            resetSlidePosition() {
                // å›å¼¹æ•ˆæœ
                const el = document.getElementById(`slide-${this.state.currentIndex}`);
                el.style.transform = 'translateY(0)';
            }

            // --- è¾…åŠ©åŠŸèƒ½ ---

            getVideoSrc(id) {
                const { server, apiKey, useStatic } = this.config;
                return useStatic 
                    ? `${server}/emby/Videos/${id}/stream?api_key=${apiKey}&Static=true`
                    : `${server}/emby/Videos/${id}/stream?api_key=${apiKey}&Container=mp4`;
            }

            getImageSrc(id) {
                const { server, apiKey } = this.config;
                // ä¼˜åŒ– 5: å‡å°å›¾ç‰‡ä½“ç§¯ MaxHeight=400
                return `${server}/emby/Items/${id}/Images/Primary?api_key=${apiKey}&MaxHeight=400&Quality=90`;
            }

            async showLibraries() {
                this.toggleLoading(true);
                try {
                    const res = await fetch(`${this.config.server}/emby/Library/VirtualFolders?api_key=${this.config.apiKey}`);
                    const data = await res.json();
                    const list = document.getElementById('librariesList');
                    list.innerHTML = '';

                    data.forEach(lib => {
                        const div = document.createElement('div');
                        const isSelected = lib.Id === this.state.currentLibraryId;
                        
                        div.className = `p-3 rounded mb-2 cursor-pointer text-sm flex justify-between items-center transition-colors ${
                            isSelected ? 'bg-gray-700 text-primary font-bold border border-primary/30' : 'bg-gray-800 text-white hover:bg-gray-700'
                        }`;
                        
                        div.innerHTML = `<span>${lib.Name}</span>${isSelected ? '<i class="fa fa-check text-primary"></i>' : ''}`;
                        
                        div.onclick = () => {
                            this.state.currentLibraryId = lib.Id;
                            this.state.currentTab = 'home';
                            this.updateTabHighlight();
                            this.fetchVideos(lib.Id);
                            this.toggleModal('libraryModal', false);
                        };
                        list.appendChild(div);
                    });
                    this.toggleModal('libraryModal', true);
                } catch(e) {
                    this.showToast('è·å–åª’ä½“åº“å¤±è´¥');
                } finally {
                    this.toggleLoading(false);
                }
            }

            toggleFavorite() {
                const item = this.state.videos[this.state.currentIndex];
                if (!item) return;
                const id = String(item.Id);

                if (this.state.favorites.has(id)) {
                    this.state.favorites.delete(id);
                    this.showToast('å·²å–æ¶ˆæ”¶è—');
                } else {
                    this.state.favorites.add(id);
                    this.showToast('æ”¶è—æˆåŠŸ');
                }
                localStorage.setItem('emby_favorites', JSON.stringify([...this.state.favorites]));
                this.updateUI();
            }

            // --- UI æ›´æ–°ä¸äº¤äº’ ---

            updateUI() {
                const item = this.state.videos[this.state.currentIndex];
                if (item) {
                    // 1. æ›´æ–°æ–‡æœ¬ä¿¡æ¯
                    this.dom.videoTitle.textContent = item.Name;
                    this.dom.videoDescription.textContent = item.Overview || 'æš‚æ— ç®€ä»‹';
                    
                    // 2. æ›´æ–°æ”¶è—å›¾æ ‡
                    const icon = this.dom.favoriteBtn.querySelector('i');
                    if (this.state.favorites.has(String(item.Id))) {
                        icon.className = 'fa fa-heart text-primary text-4xl drop-shadow-md';
                    } else {
                        icon.className = 'fa fa-heart text-white text-4xl drop-shadow-md';
                    }
                }
            }

            updateTabHighlight() {
                // é‡ç½®åº•éƒ¨å¯¼èˆªé¢œè‰²
                this.dom.favoritesBtn.className = 'flex flex-col items-center justify-center w-1/4 text-gray-400 cursor-pointer';
                this.dom.myBtn.className = 'flex flex-col items-center justify-center w-1/4 text-gray-400 cursor-pointer';
                
                // é«˜äº®å½“å‰
                if (this.state.currentTab === 'favorites') {
                    this.dom.favoritesBtn.className = 'flex flex-col items-center justify-center w-1/4 text-white cursor-pointer';
                } else if (this.state.currentTab === 'my') {
                    this.dom.myBtn.className = 'flex flex-col items-center justify-center w-1/4 text-white cursor-pointer';
                }
            }

            // ä¿®å¤ï¼šæ¸…å±æ¨¡å¼è‡ªåŠ¨éšè—é€»è¾‘
            toggleClearScreen() {
                this.state.isClearScreen = !this.state.isClearScreen;
                const app = document.getElementById('app');
                const icon = this.dom.clearScreenBtn.querySelector('i');
                const text = this.dom.clearScreenBtn.querySelector('span');

                if (this.state.isClearScreen) {
                    app.classList.add('interface-hidden');
                    icon.className = 'fa fa-eye text-white text-4xl drop-shadow-md';
                    text.textContent = 'é€€å‡º';
                    this.showToast('å·²æ¸…å± (5ç§’åè‡ªåŠ¨éšè—)');
                    
                    // è¿›å…¥æ¸…å±æ¨¡å¼ï¼Œå¯åŠ¨è®¡æ—¶
                    this.resetClearScreenTimer();
                } else {
                    app.classList.remove('interface-hidden');
                    icon.className = 'fa fa-eye-slash text-white text-4xl drop-shadow-md';
                    text.textContent = 'æ¸…å±';
                    
                    // é€€å‡ºæ¸…å±æ¨¡å¼ï¼Œæ¸…é™¤è®¡æ—¶å™¨ï¼Œç¡®ä¿æŒ‰é’®å¯è§
                    if (this.csTimer) clearTimeout(this.csTimer);
                    this.dom.clearScreenBtn.classList.remove('opacity-0', 'pointer-events-none');
                }
            }
            
            resetClearScreenTimer() {
                // ä»…åœ¨æ¸…å±æ¨¡å¼ä¸‹ç”Ÿæ•ˆ
                if (!this.state.isClearScreen) return;

                // 1. æ˜¾ç¤ºæŒ‰é’®
                this.dom.clearScreenBtn.classList.remove('opacity-0', 'pointer-events-none');
                
                // 2. æ¸…é™¤æ—§è®¡æ—¶å™¨
                if (this.csTimer) clearTimeout(this.csTimer);
                
                // 3. å¯åŠ¨æ–°è®¡æ—¶å™¨ (5ç§’åéšè—)
                this.csTimer = setTimeout(() => {
                    this.dom.clearScreenBtn.classList.add('opacity-0', 'pointer-events-none');
                }, 5000);
            }

            togglePlayMode() {
                const isSeq = this.state.playMode === 'sequence';
                this.state.playMode = isSeq ? 'random' : 'sequence';
                
                const btn = this.dom.playModeBtn;
                btn.querySelector('span').textContent = isSeq ? 'éšæœºæ’­æ”¾' : 'é¡ºåºæ’­æ”¾';
                btn.querySelector('i').className = isSeq ? 'fa fa-random text-lg' : 'fa fa-repeat text-lg';
                
                this.showToast(isSeq ? 'å·²åˆ‡æ¢éšæœºæ’­æ”¾' : 'å·²åˆ‡æ¢é¡ºåºæ’­æ”¾');
            }

            // --- äº‹ä»¶ç»‘å®š ---
            bindEvents() {
                // 1. æ’­æ”¾æ§åˆ¶
                this.dom.clickToPlayOverlay.onclick = () => {
                    this.dom.clickToPlayOverlay.style.display = 'none';
                    this.playVideo(this.state.currentIndex);
                };
                
                // 2. å³ä¾§å·¥å…·æ 
                this.dom.favoriteBtn.onclick = (e) => { e.stopPropagation(); this.toggleFavorite(); };
                this.dom.clearScreenBtn.onclick = (e) => { 
                    e.stopPropagation(); 
                    this.toggleClearScreen(); 
                };
                this.dom.muteBtn.onclick = (e) => {
                    e.stopPropagation();
                    const v = document.getElementById(`video-${this.state.currentIndex}`);
                    if (v) {
                        v.muted = !v.muted;
                        this.dom.muteBtn.querySelector('i').className = v.muted ? 'fa fa-volume-off text-white text-4xl drop-shadow-md' : 'fa fa-volume-up text-white text-4xl drop-shadow-md';
                        this.showToast(v.muted ? 'å·²é™éŸ³' : 'å·²å¼€å¯å£°éŸ³');
                    }
                };
                
                // ä¿®å¤ï¼šå…¨å±æŒ‰é’®å›¾æ ‡é€»è¾‘
                this.dom.fullscreenBtn.onclick = (e) => {
                    e.stopPropagation();
                    if (!document.fullscreenElement) {
                        document.documentElement.requestFullscreen().catch(()=>{});
                    } else {
                        document.exitFullscreen();
                    }
                };
                // ç›‘å¬å…¨å±å˜åŒ–äº‹ä»¶
                document.addEventListener('fullscreenchange', () => {
                     const icon = this.dom.fullscreenBtn.querySelector('i');
                     if(document.fullscreenElement) {
                         icon.className = 'fa fa-compress text-white text-4xl drop-shadow-md';
                     } else {
                         icon.className = 'fa fa-expand text-white text-4xl drop-shadow-md';
                     }
                });

                // 3. åº•éƒ¨å¯¼èˆª
                this.dom.playModeBtn.onclick = () => this.togglePlayMode();
                this.dom.libraryBtn.onclick = () => this.showLibraries();
                this.dom.favoritesBtn.onclick = () => {
                    if (this.state.favorites.size === 0) return this.showToast('æš‚æ— æ”¶è—');
                    this.state.currentTab = 'favorites';
                    this.state.currentLibraryId = null;
                    this.updateTabHighlight();
                    this.fetchVideos(null, [...this.state.favorites].join(','));
                };
                this.dom.myBtn.onclick = () => this.toggleModal('profilePage', true);

                // 4. å¼¹çª—æ“ä½œ
                document.getElementById('closeLibraryBtn').onclick = () => this.toggleModal('libraryModal', false);
                document.getElementById('closeProfileBtn').onclick = () => this.toggleModal('profilePage', false);
                document.getElementById('saveConfigBtn').onclick = () => this.saveConfig();
                document.getElementById('resetConfigBtn').onclick = () => this.resetConfig();

                // 5. è¿›åº¦æ¡ç‚¹å‡»
                document.getElementById('progressBarContainer').onclick = (e) => {
                    e.stopPropagation();
                    const rect = e.currentTarget.getBoundingClientRect();
                    const v = document.getElementById(`video-${this.state.currentIndex}`);
                    if (v && v.duration) v.currentTime = ((e.clientX - rect.left) / rect.width) * v.duration;
                };

                // 6. è§¦æ‘¸æ‰‹åŠ¿é€»è¾‘
                const container = this.dom.videoContainer;
                container.addEventListener('touchstart', (e) => {
                    this.touch.startY = e.touches[0].clientY;
                    this.touch.startTime = Date.now();
                }, { passive: true });

                container.addEventListener('touchend', (e) => {
                    const deltaY = e.changedTouches[0].clientY - this.touch.startY;
                    const time = Date.now() - this.touch.startTime;

                    if (Math.abs(deltaY) < 10 && time < 200) {
                        if (e.target.closest('.slide-item')) {
                            this.togglePlay();
                            // å¦‚æœåœ¨æ¸…å±æ¨¡å¼ï¼Œç‚¹å‡»å±å¹•å”¤é†’æŒ‰é’®
                            if(this.state.isClearScreen) this.resetClearScreenTimer();
                        }
                    } else if (Math.abs(deltaY) > 50) {
                        deltaY < 0 ? this.nextVideo() : this.prevVideo();
                    }
                });
                
                // PC ç‚¹å‡»å…¼å®¹
                container.addEventListener('click', (e) => {
                    if (!('ontouchstart' in window) && e.target.closest('.slide-item')) {
                        this.togglePlay();
                        if(this.state.isClearScreen) this.resetClearScreenTimer();
                    }
                });
            }

            // --- é€šç”¨è¾…åŠ© ---
            toggleModal(id, show) {
                const el = document.getElementById(id);
                if (id === 'profilePage') {
                    if (show) { el.classList.add('active'); this.state.currentTab = 'my'; }
                    else { el.classList.remove('active'); } // å…³é—­æ—¶ tab çŠ¶æ€ä¸ç«‹å³æ¢å¤ï¼Œç”±ç”¨æˆ·æ“ä½œå†³å®š
                    if(show) this.updateTabHighlight();
                } else {
                    // æ™®é€šå¼¹çª— (libraryModal)
                    if (show) el.classList.remove('hidden'); else el.classList.add('hidden');
                }
            }

            toggleLoading(show) {
                const el = this.dom.loading;
                if (show) el.classList.remove('hidden'); else el.classList.add('hidden');
            }

            showToast(msg) {
                const t = this.dom.toast;
                t.textContent = msg;
                t.classList.remove('opacity-0');
                setTimeout(() => t.classList.add('opacity-0'), 2000);
            }

            formatTime(s) {
                if (!s) return '00:00';
                const m = Math.floor(s / 60);
                const sec = Math.floor(s % 60);
                return `${m.toString().padStart(2, '0')}:${sec.toString().padStart(2, '0')}`;
            }
        }

        // å¯åŠ¨åº”ç”¨
        window.onload = () => { window.app = new EmbyApp(); };
    </script>
</body>
</html>
